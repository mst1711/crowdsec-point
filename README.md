# Nginx + CrowdSec Security Monitoring

–≠—Ç–æ—Ç docker-compose –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç nginx –≤–µ–±-—Å–µ—Ä–≤–µ—Ä —Å CrowdSec –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –∞–ª–µ—Ä—Ç–∏–Ω–≥–∞ –æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

- **Nginx** - –≤–µ–±-—Å–µ—Ä–≤–µ—Ä —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- **CrowdSec** - —Å–∏—Å—Ç–µ–º–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –≤—Ç–æ—Ä–∂–µ–Ω–∏–π –∏ –∞–Ω–∞–ª–∏–∑–∞ –ª–æ–≥–æ–≤
- **Metabase** - –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
   ```bash
   # –î–ª—è Slack - –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ crowdsec/notifications/slack.yaml
   # –£–∫–∞–∂–∏—Ç–µ –≤–∞—à webhook URL
   
   # –î–ª—è Email - –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ crowdsec/notifications/email.yaml
   # –£–∫–∞–∂–∏—Ç–µ SMTP –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
   ```

2. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã**:
   ```bash
   docker-compose up -d
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å**:
   ```bash
   docker-compose ps
   docker-compose logs crowdsec
   ```

## –î–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–∏—Å–∞–º

- **–í–µ–±-—Å–∞–π—Ç**: http://localhost:54104 –∏–ª–∏ http://localhost:57885
- **Metabase**: http://localhost:3000 (–¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞)
- **Nginx —Å—Ç–∞—Ç—É—Å**: http://localhost:54104/nginx_status

## –ß—Ç–æ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—Å—è

CrowdSec –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ª–æ–≥–∏ nginx –∏ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç:

### ü§ñ –ë–æ—Ç—ã –∏ —Å–∫–∞–Ω–µ—Ä—ã
- –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ User-Agent
- –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ü–æ–ø—ã—Ç–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∫—Ä—ã—Ç—ã–º —Ñ–∞–π–ª–∞–º

### üåä DDoS –∞—Ç–∞–∫–∏
- –ê–Ω–æ–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –æ–¥–Ω–æ–≥–æ IP
- HTTP —Ñ–ª—É–¥ –∞—Ç–∞–∫–∏
- –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤

### üîì –ë—Ä—É—Ç—Ñ–æ—Ä—Å –∞—Ç–∞–∫–∏
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –¥–æ—Å—Ç—É–ø–∞
- –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
- –ü–æ–ø—ã—Ç–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–º –ø–∞–Ω–µ–ª—è–º

### üïµÔ∏è –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
- –ü–æ–ø—ã—Ç–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º —Ñ–∞–π–ª–∞–º
- –ü–æ–∏—Å–∫ –±—ç–∫–∞–ø–æ–≤ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### Slack
1. –°–æ–∑–¥–∞–π—Ç–µ Incoming Webhook –≤ –≤–∞—à–µ–º Slack workspace
2. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `crowdsec/notifications/slack.yaml`
3. –£–∫–∞–∂–∏—Ç–µ URL webhook –≤ –ø–æ–ª–µ `url`

### Email
1. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `crowdsec/notifications/email.yaml`
2. –£–∫–∞–∂–∏—Ç–µ SMTP –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∞—à–µ–≥–æ –ø–æ—á—Ç–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
3. –î–æ–±–∞–≤—å—Ç–µ email –∞–¥—Ä–µ—Å–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –≤ `recipients`

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

### –°–∏–º—É–ª—è—Ü–∏—è DDoS –∞—Ç–∞–∫–∏
```bash
# –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –±—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã
for i in {1..100}; do curl -s http://localhost:54104/ > /dev/null; done
```

### –°–∏–º—É–ª—è—Ü–∏—è –±–æ—Ç–∞
```bash
# –ó–∞–ø—Ä–æ—Å —Å –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–º User-Agent
curl -H "User-Agent: sqlmap/1.0" http://localhost:54104/
```

### –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
```bash
# –ü–æ–ø—ã—Ç–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —Ñ–∞–π–ª–∞–º
curl http://localhost:54104/admin/
curl http://localhost:54104/.env
curl http://localhost:54104/config.php
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
```bash
# –õ–æ–≥–∏ nginx
docker compose logs nginx

# –õ–æ–≥–∏ CrowdSec
docker compose logs crowdsec

# –ê–ª–µ—Ä—Ç—ã CrowdSec
docker compose exec crowdsec cscli alerts list
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```bash
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–π
docker compose exec crowdsec cscli metrics

# –ê–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è (–±–∞–Ω-–ª–∏—Å—Ç)
docker compose exec crowdsec cscli decisions list
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
.
‚îú‚îÄ‚îÄ docker-compose.yml          # –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ nginx/
‚îÇ   ‚îú‚îÄ‚îÄ nginx.conf             # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è nginx
‚îÇ   ‚îî‚îÄ‚îÄ default.conf           # –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ö–æ—Å—Ç
‚îú‚îÄ‚îÄ crowdsec/
‚îÇ   ‚îú‚îÄ‚îÄ acquis.yaml            # –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ config.yaml            # –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ profiles.yaml          # –ü—Ä–æ—Ñ–∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞–ª–µ—Ä—Ç–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ notifications/         # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
‚îÇ       ‚îú‚îÄ‚îÄ slack.yaml
‚îÇ       ‚îî‚îÄ‚îÄ email.yaml
‚îú‚îÄ‚îÄ html/
‚îÇ   ‚îî‚îÄ‚îÄ index.html             # –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
‚îî‚îÄ‚îÄ logs/
    ‚îî‚îÄ‚îÄ nginx/                 # –õ–æ–≥–∏ nginx
```

## –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

- **–†–µ–∂–∏–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**: CrowdSec –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Ç–æ–ª—å–∫–æ –Ω–∞ –∞–ª–µ—Ä—Ç–∏–Ω–≥, —Ç—Ä–∞—Ñ–∏–∫ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
- **–õ–æ–≥–∏**: –í—Å–µ —Å–æ–±—ã—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö CrowdSec –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –≤–ª–∏—è–Ω–∏—è –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: Nginx –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å –±–∞–∑–æ–≤—ã–º–∏ –º–µ—Ä–∞–º–∏ –∑–∞—â–∏—Ç—ã

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### –í–∫–ª—é—á–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É:

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ bouncer –¥–ª—è nginx:
   ```bash
   docker compose exec crowdsec cscli bouncers add nginx-bouncer
   ```

2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ nginx –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è CrowdSec API

### –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –≤ `/etc/crowdsec/scenarios/`

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏
CrowdSec –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ SIEM —Å–∏—Å—Ç–µ–º–∞–º–∏ –∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.